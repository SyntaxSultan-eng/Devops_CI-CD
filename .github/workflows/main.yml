name: CI/CD Pipeline

on:
  push: #Триггер для push
    branches: [main]

  pull_request: #Триггер для pull-request
    branches: [main]

  workflow_dispatch: #Ручной запуск workflow

jobs:
  build:
    runs-on: self-hosted

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: .env File 
      run: | #Here document, либо echo для каждой строки
        cat >> .env << EOF 
        DJANGO_SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}
        DATABASE_HOST=${{ secrets.DATABASE_HOST }}
        DATABASE_NAME=${{ secrets.DATABASE_NAME }}
        DATABASE_USER=${{ secrets.DATABASE_USER }}
        DATABASE_PASSWORD=${{ secrets.DATABASE_PASSWORD }}
        DATABASE_PORT=${{ secrets.DATABASE_PORT }}
        DATABASE_AUTH=${{ secrets.DATABASE_AUTH }}
        EOF
    - name: Docker-compose
      run: |
        docker compose up -d
        sleep 60
        docker compose ps
        
    - name: Wait for database to be ready
      run: |
        # Ждем пока база данных будет готова принимать подключения
        for i in {1..30}; do
          if docker compose exec db mysql -h127.0.0.1 -u${{ secrets.DATABASE_USER }} -p${{ secrets.DATABASE_PASSWORD }} -e "SELECT 1;" 2>/dev/null; then
            echo "✅ Database is ready!"
            break
          fi
          echo "⏳ Waiting for database... ($i/30)"
          sleep 2
        done

    - name: Run Django migrations
      run: |
        docker compose exec web python manage.py migrate