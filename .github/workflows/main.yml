name: CI/CD Pipeline

on:
  push: #Ð¢Ñ€Ð¸Ð³Ð³ÐµÑ€ Ð´Ð»Ñ push
    branches: [main]

  pull_request: #Ð¢Ñ€Ð¸Ð³Ð³ÐµÑ€ Ð´Ð»Ñ pull-request
    branches: [main]

  workflow_dispatch: #Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº workflow

jobs:
  build:
    runs-on: self-hosted

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Clear container
      run: |
        docker compose down

    - name: .env File 
      run: | #Here document, Ð»Ð¸Ð±Ð¾ echo Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð¹ ÑÑ‚Ñ€Ð¾ÐºÐ¸
        cat >> .env << EOF 
        DJANGO_SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}
        DATABASE_HOST=${{ secrets.DATABASE_HOST }}
        DATABASE_NAME=${{ secrets.DATABASE_NAME }}
        DATABASE_USER=${{ secrets.DATABASE_USER }}
        DATABASE_PASSWORD=${{ secrets.DATABASE_PASSWORD }}
        DATABASE_PORT=${{ secrets.DATABASE_PORT }}
        DATABASE_AUTH=${{ secrets.DATABASE_AUTH }}
        APP_PORT=${{ secrets.APP_PORT }}
        EOF

    - name: Docker-compose
      run: |
        docker compose up -d --build
        sleep 60
        docker compose ps

    - name: Run Django migrations
      run: |
        docker compose exec web python myproject/manage.py migrate
    
    - name: Check_containers
      run: |
        if docker-compose ps | grep -q "Up"; then
          echo "All containers are running"
        else
          echo "Some containers failed to start"
          docker-compose logs
          exit 1
        fi

    - name: 1 Test
      run: |
        if curl -f http://localhost:${{ secrets.APP_PORT }}; then
          echo "Web application is healthy"
        else
          echo "Web application health check failed"
        exit 1
        fi

        # Ð•ÑÐ»Ð¸ /check_db Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ Ð»ÑŽÐ±Ð¾Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚ Ð±ÐµÐ· Ð¾ÑˆÐ¸Ð±Ð¾Ðº - ÑÑ‡Ð¸Ñ‚Ð°ÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð‘Ð” Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚
        if curl -s -f http://localhost:${{ secrets.APP_PORT }}/check_db; then
          echo "Database connection working"
        else
          echo "Database connection failed"
          exit 1
        fi
    
    - name: 2 Test
      run: |
        # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð·Ð°Ð¿Ð¸ÑÐµÐ¹ Ñ‡ÐµÑ€ÐµÐ· Ð²ÐµÐ±-Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ (Ð¸Ð· HTML)
        WEB_RESPONSE=$(curl -s http://localhost:${{ secrets.APP_PORT }})
        WEB_COUNT=$(echo "$WEB_RESPONSE" | grep -o 'Ð’ÑÐµÐ³Ð¾ Ð·Ð°Ð¿Ð¸ÑÐµÐ¹ Ð² Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ðµ: <strong>[0-9]*' | grep -o '[0-9]*$')
        
        # Ð²Ñ‹Ð´Ð°ÐµÑ‚ Ñ‡Ð¸ÑÑ‚Ð¾Ðµ Ñ‡Ð¸ÑÐ»Ð¾ Ð±ÐµÐ· Ð¿Ñ€Ð¾Ð±ÐµÐ»Ð¾Ð²
        DB_COUNT=$(docker compose exec -T db mysql -u${{ secrets.DATABASE_USER }} -p${{ secrets.DATABASE_PASSWORD }} ${{ secrets.DATABASE_NAME }} -s -N -e "SELECT COUNT(*) FROM myapp_counter;" | tr -d ' ')
    

        echo "Database count: $DB_COUNT"
        echo "Web interface count: $WEB_COUNT"
        
        if [ "$DB_COUNT" = "$WEB_COUNT" ]; then
          echo "Data consistency test passed"
        else
          echo "Data consistency test failed"
          exit 1
        fi

    - name: Create test report
      run: |
        echo "ðŸ“‹ Creating test report..."
        cat > test-report.md << EOF
        # Deployment Test Report
        - Date: $(date)
        - Application: Healthy âœ…
        - Database: Connected âœ…
        - Data Consistency: Passed âœ…
        - Containers: Running âœ…
        ## Environment Variables
        - DB_HOST: ${{ secrets.DB_HOST }}
        - DB_NAME: ${{ secrets.DB_NAME }}
        - APP_PORT: ${{ secrets.APP_PORT }}
        ## Test Results
        - Database records: $DB_COUNT
        - Web API records: $WEB_COUNT
        EOF

    - name: Save artifacts
      uses: actions/upload-artifact@v4
      with:
        name: deployment-artifacts
        path: |
          .env
          test-report.md
          deployment-logs.txt
          retention-days: 30

    - name: Save Docker logs
      if: always()
      run: |
        docker-compose logs > deployment-logs.txt
        docker images > docker-images.txt
        docker ps -a > docker-ps.txt
        
    - name: Upload Docker logs as artifact
      uses: actions/upload-artifact@v4
      with:
        name: docker-logs
        path: |
          deployment-logs.txt
          docker-images.txt
          docker-ps.txt
          retention-days: 30